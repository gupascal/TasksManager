<?php

namespace TMS\TasksManagerBundle\Entity;

use Doctrine\ORM\EntityRepository;
use Doctrine\ORM\Query\Expr\Join;

/**
 * TaskRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class TaskRepository extends EntityRepository
{
	private function whereUserIs(\Doctrine\ORM\QueryBuilder $qb, $username)
	{
		if ($username !== null) {
			$qb->innerJoin('TMS\UsersBundle\Entity\User', 'u', Join::WITH, 't.user = u.id')
				->andWhere('u.username = :username')
				->setParameter('username', $username);
		}
	}

	public function findAllRunningTasksOrderedByDueDate($username)
	{
		$qb = $this->createQueryBuilder('t');
		$this->whereUserIs($qb, $username);
		return $qb//->andWhere('t.date_completed IS NOT NULL')
					->orderBy('t.due_date', 'ASC')
					->getQuery()
					->getResult();
	}
	
	public function findUserTask($username, $taskid)
	{
		$qb = $this->createQueryBuilder('t');
		$this->whereUserIs($qb, $username);
		return $qb->andWhere('t.id = :id')
						->setParameter('id', $taskid)
						->getQuery()
						->getOneOrNullResult();
	}
	
	public function findNextTasks($username, $limit)
	{
		$qb = $this->createQueryBuilder('t');
		$this->whereUserIs($qb, $username);
		return $qb->andWhere('t.date_started IS NULL')
					->orderBy('t.due_date', 'ASC')
					//->setFirstResult($offset)
					->setMaxResults($limit)
					->getQuery()
					->getResult();
	}
	
	public function findTasksInProgress($username, $limit)
	{
		$qb = $this->createQueryBuilder('t');
		$this->whereUserIs($qb, $username);
		return $qb->andWhere('t.date_started IS NOT NULL')
					->andWhere('t.date_completed IS NULL')
					->orderBy('t.due_date', 'ASC')
					//->setFirstResult($offset)
					->setMaxResults($limit)
					->getQuery()
					->getResult();
	}
	
	// public function hasUncompletedDependances($username, $taskid)
	// {
		// $qb = $this->createQueryBuilder('t')
					// ->innerJoin('t.dep_tasks', 'dt');
		// $this->whereUserIs($qb, $username);
		// return $qb->andWhere('t.id = :id')
						// ->setParameter('id', $taskid)
						// ->getQuery()
						// ->getOneOrNullResult();
	// }
	
	public function taskHasValidDueDate($task)
	{
		// Check the due date regarding tasks that depend of the current task
		$qb = $this->createQueryBuilder('t')
					->innerJoin('t.related_tasks', 'rt');
		$res = $qb->where('t.id = :id')
					->setParameter('id', $task->getId())
					->andWhere('rt.due_date <= :dueDate')
					->setParameter('dueDate', $task->getDueDate())
					->orderBy('rt.due_date', 'ASC')
					->setMaxResults(1)
					->getQuery()
					->getOneOrNullResult();
		
		if ($res !== null)
			return false;
	
		// Check the due date regarding the current task and its own dependencies
		$qb = $this->createQueryBuilder('t')
					->innerJoin('t.dep_tasks', 'dt');
		$res = $qb->where('t.id = :id')
					->setParameter('id', $task->getId())
					->andWhere('dt.due_date >= :dueDate')
					->setParameter('dueDate', $task->getDueDate())
					->orderBy('dt.due_date', 'DESC')
					->setMaxResults(1)
					->getQuery()
					->getOneOrNullResult();
		
		if ($res !== null)
			return false;
		return true;
	}
	
	
	
	public function findDependencies($username, $task)
	{
		$qb = $this->createQueryBuilder('t')
					->innerJoin('t.dep_tasks', 'dt');
		$this->whereUserIs($qb, $username);
		return $qb->andWhere('t.id = :id')
						->setParameter('id',  $task->getId())
						//->andWhere('dt.due_date < :dueDate')
						//->setParameter('dueDate', $task->getDueDate())
						->getQuery()
						->getResult();
	}
	
	public function findPossibleDependencies($username, $task)
	{
		$qb = $this->createQueryBuilder('t');
		$this->whereUserIs($qb, $username);
		return $qb->andWhere('t.due_date < :dueDate')
						->setParameter('dueDate', $task->getDueDate())
						->andWhere('t.id != ALL (SELECT dt.id FROM TMS\TasksManagerBundle\Entity\Task t_ INNER JOIN t_.dep_tasks dt WHERE t_.id = '.(int)$task->getId().')')
						->getQuery()
						->getResult();
	}
	
	public function findFilteredTasks($username, \Symfony\Component\Form\Form /* TaskFiltersType */ $filters_form)
	{
		if (!$filters_form->isValid()) {
			return $this->findAllRunningTasksOrderedByDueDate($username);
		}
	
		$qb = $this->createQueryBuilder('t');

		$this->whereUserIs($qb, $username);
		
		// Name filter
		$name_filter = $filters_form['name_filter']->getData();
		$name = $filters_form['name']->getData();
		if ($name != null)
		{
			if ($name_filter == "contains") {
				$qb->andWhere('t.name LIKE :name')
					->setParameter('name', '%'.$name.'%');
			}
			else if ($name_filter == "does_not_contain") {
				$qb->andWhere('t.name NOT LIKE :name')
					->setParameter('name', '%'.$name.'%');
			}
			else if ($name_filter == "begins_with") {
				$qb->andWhere('t.name LIKE :name')
					->setParameter('name', $name.'%');
			}
			else if ($name_filter == "ends_with") {
				$qb->andWhere('t.name LIKE :name')
					->setParameter('name', '%'.$name);
			}
		}
		
		// Priority filter
		$priority_filter = $filters_form['priority_filter']->getData();
		$priority = $filters_form['priority']->getData();
		if (array_key_exists($priority, Task::getPriorities()))
		{
			if ($priority_filter == "is_greater_than") {
				$qb->andWhere('t.priority > :priority')
					->setParameter('priority', $priority);
			}
			else if ($priority_filter == "is_greater_or_equal_to") {
				$qb->andWhere('t.priority >= :priority')
					->setParameter('priority', $priority);
			}
			else if ($priority_filter == "is_equal_to") {
				$qb->andWhere('t.priority = :priority')
					->setParameter('priority', $priority);
			}
			else if ($priority_filter == "is_lower_or_equal_to") {
				$qb->andWhere('t.priority <= :priority')
					->setParameter('priority', $priority);
			}
			else if ($priority_filter == "is_lower_than") {
				$qb->andWhere('t.priority < :priority')
					->setParameter('priority', $priority);
			}
		}
		
		// Due Date filter
		$due_date_filter = $filters_form['due_date_filter']->getData();
		$due_date = $filters_form['due_date']->getData();
		if ($due_date != null)
		{
			if ($due_date_filter == "is_newer_than") {
				$qb->andWhere('t.due_date > :due_date')
					->setParameter('due_date', $due_date);
			}
			else if ($due_date_filter == "is_older_than") {
				$qb->andWhere('t.due_date < :due_date')
					->setParameter('due_date', $due_date);
			}
		}
		
		return $qb->getQuery()->getResult();
	}
}
